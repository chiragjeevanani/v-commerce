import{i as Q,k as X,r as n,s as ee,j as e,M as se,o as ae,t as te,m as u,A as M,l as re,B as y,v as h}from"./index-BOPlgZ3J.js";import{a as k}from"./api-DUNy1eYZ.js";import{a as T}from"./address.service-CWR7hoQR.js";import"./label-BW8eO7Km.js";import{C as $,c as B,d as V,a as q}from"./card-B7rOivQ7.js";import{A as ie}from"./AddressForm-WaAf-Rzn.js";import{S as ne}from"./separator-DDxKSqXe.js";import{A as S}from"./AnimatedNumber-BGkptNV6.js";import{P as de}from"./plus-gUIvaxu1.js";import{T as le}from"./truck-BMfTK7P6.js";import"./index-BEWmTAkE.js";const ce=[{id:1,name:"Shipping",icon:se},{id:2,name:"Payment",icon:ae},{id:3,name:"Review",icon:te}],ke=()=>{const g=Q(),{cart:o,cartTotal:b,clearCart:z}=X(),[d,_]=n.useState(1),[D,p]=n.useState(!1),C=n.useRef(!1),[l,L]=n.useState("cod"),{user:j}=ee(),[c,H]=n.useState([]),[m,O]=n.useState(null),[N,v]=n.useState(!1),[r,U]=n.useState({firstName:j?.fullName?.split(" ")[0]||"",lastName:j?.fullName?.split(" ")[1]||"",address:"",city:"",state:"",zip:"",phoneNumber:j?.phoneNumber||"",email:j?.email||"",cardNumber:"",expiry:"",cvc:""}),[oe,A]=n.useState([]),[w,P]=n.useState(null),[W,E]=n.useState(!1),[I,R]=n.useState(""),[me,pe]=n.useState(null);n.useEffect(()=>{o.length===0&&!C.current&&g("/cart"),(async()=>{try{const t=await T.getAddresses();H(t);const a=t.find(i=>i.isDefault)||t[0];a?(O(a._id),v(!1)):v(!0)}catch(t){console.error("Failed to load addresses",t)}})()},[o,g]),n.useEffect(()=>{(async()=>{if(o.length>0){const t=o.filter(a=>!a.isStoreProduct);if(t.length===0){A([{name:"Standard Shipping",price:0,time:"5-7 business days"}]),P({name:"Standard Shipping",price:0,time:"5-7 business days"}),R("5-7 business days");return}E(!0);try{const a=await k.estimateShipping({pid:t[0].pid,quantity:t[0].quantity,countryCode:"IN"});if(a.success&&a.data&&a.data.length>0){A(a.data);const i=a.data[0];P(i),R(i.time)}}catch(a){console.error("Shipping estimate failed",a),A([{name:"Standard Shipping",price:0,time:"5-7 business days"}]),P({name:"Standard Shipping",price:0,time:"5-7 business days"})}finally{E(!1)}}})()},[o]),n.useEffect(()=>{const s=document.createElement("script");return s.src="https://checkout.razorpay.com/v1/checkout.js",s.async=!0,document.body.appendChild(s),()=>{document.body.removeChild(s)}},[]);const J=s=>{U({...r,[s.target.name]:s.target.value})},Y=()=>{_(s=>Math.min(s+1,3))},Z=()=>{_(s=>Math.max(s-1,1))},G=async()=>{p(!0);try{let s=null;if(N){if(!r.address||!r.city||!r.zip){h({title:"Error",description:"Please fill all shipping details",variant:"destructive"}),p(!1);return}const i=(await T.addAddress({fullName:`${r.firstName} ${r.lastName}`,street:r.address,city:r.city,state:r.state,zipCode:r.zip,phoneNumber:r.phoneNumber,isDefault:c.length===0})).data;s=i[i.length-1]}else s=c.find(a=>a._id===m);if(!s){h({title:"Error",description:"Please select a shipping address",variant:"destructive"}),p(!1);return}const t=b*1.1+(w?.fee||0);if(l==="cod"){const a=await k.placeOrder({items:o,total:t,shipping:s,paymentMethod:l});C.current=!0,z(),g("/order-success",{state:{orderId:a.orderId,total:t,paymentMethod:"Cash on Delivery",orderData:a.orderData}})}else if(l==="online"){const a=await k.createRazorpayOrder(t);if(!a.success)throw new Error("Failed to create payment order");const i=a.order,K={key:"rzp_test_8sYbzHWidwe5Zw",amount:i.amount,currency:i.currency,name:"V-Commerce",description:"Order Payment",order_id:i.id,handler:async function(f){p(!0);try{const x=await k.verifyRazorpayPayment({razorpay_order_id:f.razorpay_order_id,razorpay_payment_id:f.razorpay_payment_id,razorpay_signature:f.razorpay_signature,orderData:{items:o,total:t,shipping:s}});x.success?(C.current=!0,z(),g("/order-success",{state:{orderId:x.orderId,total:t,paymentMethod:"Online (Razorpay)",orderData:x.orderData}})):h({title:"Payment Verification Failed",description:x.message,variant:"destructive"})}catch(x){console.error("Verification failed",x),h({title:"Verification Error",description:x.message,variant:"destructive"})}finally{p(!1)}},prefill:{name:s.fullName,email:JSON.parse(localStorage.getItem("user"))?.email||"",contact:s.phoneNumber},theme:{color:"#000000"}},F=new window.Razorpay(K);F.on("payment.failed",function(f){h({title:"Payment Failed",description:f.error.description,variant:"destructive"})}),F.open(),p(!1)}}catch(s){console.error("Order failed",s),h({title:"Order Failed",description:s.message||"Something went wrong. Please try again.",variant:"destructive"})}finally{l!=="online"&&p(!1)}};return e.jsxs("div",{className:"container py-8 max-w-4xl min-h-screen",children:[e.jsx("div",{className:"mb-12",children:e.jsxs("div",{className:"flex items-center justify-between relative max-w-2xl mx-auto",children:[e.jsx("div",{className:"absolute left-0 top-1/2 w-full h-1 bg-muted -translate-y-1/2 -z-10"}),ce.map(s=>{const t=s.icon,a=s.id===d,i=s.id<d;return e.jsxs("div",{className:"flex flex-col items-center bg-background px-4",children:[e.jsx(u.div,{initial:!1,animate:{backgroundColor:a||i?"hsl(var(--primary))":"hsl(var(--background))",borderColor:a||i?"hsl(var(--primary))":"hsl(var(--muted-foreground))",color:a||i?"hsl(var(--primary-foreground))":"hsl(var(--muted-foreground))",scale:a?1.2:1},className:"flex items-center justify-center w-12 h-12 rounded-full border-2 transition-all duration-500 shadow-lg",children:e.jsx(t,{className:"h-6 w-6"})}),e.jsx("span",{className:`mt-3 text-xs md:text-sm font-bold uppercase tracking-widest ${a||i?"text-primary":"text-muted-foreground opacity-50"}`,children:s.name})]},s.id)})]})}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs($,{className:"border-none shadow-2xl bg-card rounded-3xl overflow-hidden",children:[e.jsx(B,{className:"bg-primary/5 border-b border-primary/10 py-6",children:e.jsxs(V,{className:"text-2xl font-black text-primary",children:[d===1&&"Shipping Details",d===2&&"Payment Method",d===3&&"Review Order"]})}),e.jsxs(q,{className:"p-6 md:p-8",children:[e.jsxs(M,{mode:"wait",children:[d===1&&e.jsxs(u.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"space-y-8",children:[!N&&c.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.3em] text-muted-foreground",children:"Select Shipping Address"}),e.jsx("div",{className:"grid gap-4",children:c.map(s=>e.jsxs("button",{onClick:()=>O(s._id),className:`flex items-start gap-4 p-5 rounded-3xl border-2 text-left transition-all ${m===s._id?"border-primary bg-primary/5 shadow-inner":"border-border hover:border-primary/20"}`,children:[e.jsx("div",{className:`mt-1 h-5 w-5 rounded-full border-2 flex items-center justify-center ${m===s._id?"border-primary":"border-muted-foreground/30"}`,children:m===s._id&&e.jsx("div",{className:"h-2.5 w-2.5 rounded-full bg-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-black text-sm",children:s.fullName}),e.jsx(re,{variant:"outline",className:"text-[9px] py-0",children:s.addressType})]}),e.jsxs("p",{className:"text-xs text-muted-foreground leading-tight",children:[s.street,", ",s.city,", ",s.state," ",s.zipCode]})]})]},s._id))}),e.jsxs(y,{variant:"outline",className:"w-full rounded-2xl border-dashed h-14 font-bold",onClick:()=>v(!0),children:[e.jsx(de,{className:"h-4 w-4 mr-2"})," Add New Address"]})]}),(N||c.length===0)&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.3em] text-muted-foreground",children:"New Shipping Address"}),c.length>0&&e.jsx(y,{variant:"ghost",size:"sm",className:"text-[10px] font-black uppercase",onClick:()=>v(!1),children:"Use Saved Address"})]}),e.jsx(ie,{formData:r,handleChange:J,showSubmitButton:!1})]})]},"step1"),d===2&&e.jsxs(u.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"space-y-8",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[{id:"online",name:"Online Payment",icon:"ðŸ’³",disabled:!1},{id:"cod",name:"Cash on Delivery",icon:"ðŸ’µ",disabled:!1}].map(s=>e.jsxs("button",{type:"button",onClick:()=>!s.disabled&&L(s.id),disabled:s.disabled,className:`p-6 rounded-3xl border-2 flex flex-col items-center gap-4 transition-all relative ${l===s.id?"border-primary bg-primary/5 shadow-inner scale-105":"border-border hover:border-primary/50"} ${s.disabled?"opacity-50 cursor-not-allowed grayscale":""}`,children:[e.jsx("span",{className:"text-3xl",children:s.icon}),e.jsx("span",{className:"font-black text-xs uppercase tracking-widest",children:s.name}),l===s.id&&e.jsx(u.div,{layoutId:"active",className:"h-2 w-2 rounded-full bg-primary mt-auto"})]},s.id))}),e.jsx("div",{className:"pt-6 border-t border-dashed",children:e.jsxs(M,{mode:"wait",children:[l==="cod"&&e.jsxs(u.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"p-8 rounded-[40px] bg-green-500/5 flex flex-col items-center text-center space-y-4 border border-green-500/10",children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-green-500/10 flex items-center justify-center text-3xl",children:"ðŸ’µ"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-black text-xl",children:"Cash on Delivery"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pay the amount to the delivery associate when your package arrives at your doorstep."})]})]},"cod-info"),l==="online"&&e.jsxs(u.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"p-8 rounded-[40px] bg-primary/5 flex flex-col items-center text-center space-y-4 border border-primary/10",children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-primary/10 flex items-center justify-center text-3xl",children:"ðŸ’³"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-black text-xl",children:"Secure Online Payment"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pay securely using Cards, NetBanking, UPI, or Wallets via Razorpay."})]})]},"online-info")]})})]},"step2"),d===3&&e.jsxs(u.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"space-y-6",children:[e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"rounded-2xl border bg-muted/30 p-6 space-y-3",children:[e.jsx("h4",{className:"font-black uppercase text-xs tracking-widest text-primary",children:"Shipping To:"}),e.jsx("p",{className:"text-sm font-medium leading-relaxed",children:N?e.jsxs(e.Fragment,{children:[r.firstName," ",r.lastName,e.jsx("br",{}),r.address,e.jsx("br",{}),r.city,", ",r.zip]}):e.jsxs(e.Fragment,{children:[c.find(s=>s._id===m)?.fullName,e.jsx("br",{}),c.find(s=>s._id===m)?.street,e.jsx("br",{}),c.find(s=>s._id===m)?.city,", ",c.find(s=>s._id===m)?.zipCode]})})]}),e.jsxs("div",{className:"rounded-2xl border bg-muted/30 p-6 space-y-3",children:[e.jsx("h4",{className:"font-black uppercase text-xs tracking-widest text-primary",children:"Payment Via:"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-2xl",children:l==="online"?"ðŸ’³":"ðŸ’µ"}),e.jsx("p",{className:"text-sm font-black uppercase tracking-widest",children:l==="online"?"Online Payment":"Cash on Delivery"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-black uppercase text-xs tracking-widest text-primary",children:"Items in Order:"}),e.jsx("div",{className:"space-y-3",children:o.map((s,t)=>e.jsxs("div",{className:"flex justify-between items-center text-sm p-3 bg-muted/30 rounded-xl",children:[e.jsxs("span",{className:"font-medium",children:[e.jsxs("span",{className:"text-primary font-black mr-2",children:[s.quantity,"x"]})," ",s.name]}),e.jsxs("span",{className:"font-black",children:["â‚¹",e.jsx(S,{value:(s.discountPrice||s.price)*s.quantity,decimals:2})]})]},s.pid||s.id||t))})]})]},"step3")]}),e.jsxs("div",{className:"flex justify-between pt-10 border-t mt-10",children:[d>1?e.jsx(y,{variant:"ghost",onClick:Z,className:"rounded-full px-8 hover:bg-muted font-bold uppercase tracking-widest text-xs",children:"Back"}):e.jsx("div",{}),d<3?e.jsx(y,{onClick:Y,className:"rounded-full px-12 font-bold uppercase tracking-widest text-xs shadow-lg hover:shadow-primary/20 scale-105 transition-all",children:"Next Step"}):e.jsx(y,{onClick:G,disabled:D,className:"rounded-full px-12 font-bold uppercase tracking-widest text-xs shadow-lg hover:shadow-primary/20 scale-105 transition-all",children:D?"Processing...":"Place Order"})]})]})]})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs($,{className:"sticky top-24 border-none shadow-xl bg-card rounded-3xl overflow-hidden",children:[e.jsx(B,{className:"bg-primary py-6",children:e.jsx(V,{className:"text-xl font-black text-primary-foreground uppercase tracking-widest",children:"Summary"})}),e.jsxs(q,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-3 text-sm font-medium",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsxs("span",{className:"font-black",children:["â‚¹",e.jsx(S,{value:b,decimals:2})]})]}),e.jsxs("div",{className:"flex justify-between items-center text-primary",children:[e.jsx("span",{className:"text-muted-foreground font-medium",children:"Shipping Fee"}),e.jsx("span",{className:"font-black",children:W?"...":w?`â‚¹${w.fee}`:"Calculated at next step"})]}),I&&e.jsxs("div",{className:"flex justify-between items-center text-green-600 bg-green-50 p-2 rounded-lg border border-green-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-3 w-3"}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest",children:"Est. Delivery"})]}),e.jsxs("span",{className:"text-[10px] font-black",children:[I," Days"]})]}),e.jsxs("div",{className:"flex justify-between items-center border-t pt-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Tax (10%)"}),e.jsxs("span",{className:"font-black",children:["â‚¹",e.jsx(S,{value:b*.1,decimals:2})]})]})]}),e.jsx(ne,{className:"opacity-50"}),e.jsx("div",{className:"flex justify-between items-end",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground mb-1",children:"Total Amount"}),e.jsxs("span",{className:"text-3xl font-black text-primary leading-none",children:["â‚¹",e.jsx(S,{value:b*1.1+(w?.fee||0),decimals:2})]})]})})]})]})})]})]})};export{ke as default};

import{i as ae,k as te,r,s as re,j as e,M as ie,o as ne,t as de,m as h,A as T,l as le,B as y,v as x}from"./index-BpRMWdVM.js";import{a as g}from"./api-CjDPd_c3.js";import{a as $}from"./address.service-BOoEARUx.js";import"./label-XkaMJijg.js";import{C as B,c as K,d as V,a as q}from"./card-CyVSnPS_.js";import{A as ce}from"./AddressForm-Bsqdl1Hg.js";import{S as oe}from"./separator-DF53nTyw.js";import{A as S}from"./AnimatedNumber-Dm71TD1h.js";import{P as me}from"./plus-cVjnq_g6.js";import{T as pe}from"./truck-ky9tsUIx.js";import"./index-C_G7Jul-.js";const xe=[{id:1,name:"Shipping",icon:ie},{id:2,name:"Payment",icon:ne},{id:3,name:"Review",icon:de}],Pe=()=>{const b=ae(),{cart:m,cartTotal:j,clearCart:A}=te(),[d,_]=r.useState(1),[R,c]=r.useState(!1),C=r.useRef(!1),[o,L]=r.useState("online"),{user:N}=re(),[l,G]=r.useState([]),[p,D]=r.useState(null),[v,w]=r.useState(!1),[i,U]=r.useState({firstName:N?.fullName?.split(" ")[0]||"",lastName:N?.fullName?.split(" ")[1]||"",address:"",city:"",state:"",zip:"",phoneNumber:N?.phoneNumber||"",email:N?.email||"",cardNumber:"",expiry:"",cvc:""}),[ue,z]=r.useState([]),[k,P]=r.useState(null),[H,E]=r.useState(!1),[I,O]=r.useState(""),[he,fe]=r.useState(null);r.useEffect(()=>{m.length===0&&!C.current&&b("/cart"),(async()=>{try{const t=await $.getAddresses();G(t);const a=t.find(n=>n.isDefault)||t[0];a?(D(a._id),w(!1)):w(!0)}catch(t){console.error("Failed to load addresses",t)}})()},[m,b]),r.useEffect(()=>{(async()=>{if(m.length>0){const t=m.filter(a=>!a.isStoreProduct);if(t.length===0){z([{name:"Standard Shipping",price:0,time:"5-7 business days"}]),P({name:"Standard Shipping",price:0,time:"5-7 business days"}),O("5-7 business days");return}E(!0);try{const a=await g.estimateShipping({pid:t[0].pid,quantity:t[0].quantity,countryCode:"IN"});if(a.success&&a.data&&a.data.length>0){z(a.data);const n=a.data[0];P(n),O(n.time)}}catch(a){console.error("Shipping estimate failed",a),z([{name:"Standard Shipping",price:0,time:"5-7 business days"}]),P({name:"Standard Shipping",price:0,time:"5-7 business days"})}finally{E(!1)}}})()},[m]);const[F,J]=r.useState(null),[W,Q]=r.useState(!1);r.useEffect(()=>{const s=document.createElement("script");return s.src="https://checkout.razorpay.com/v1/checkout.js",s.async=!0,document.body.appendChild(s),(async()=>{try{const a=await g.getRazorpayPublicKey();a.success&&a.keyId&&(J(a.keyId),Q(a.isEnabled!==!1))}catch(a){console.error("Failed to load Razorpay key:",a)}})(),()=>{document.body.contains(s)&&document.body.removeChild(s)}},[]);const X=s=>{U({...i,[s.target.name]:s.target.value})},Y=()=>{_(s=>Math.min(s+1,3))},Z=()=>{_(s=>Math.max(s-1,1))},ee=async()=>{c(!0);try{let s=null;if(v){if(!i.address||!i.city||!i.zip){x({title:"Error",description:"Please fill all shipping details",variant:"destructive"}),c(!1);return}const n=(await $.addAddress({fullName:`${i.firstName} ${i.lastName}`,street:i.address,city:i.city,state:i.state,zipCode:i.zip,phoneNumber:i.phoneNumber,isDefault:l.length===0})).data;s=n[n.length-1]}else s=l.find(a=>a._id===p);if(!s){x({title:"Error",description:"Please select a shipping address",variant:"destructive"}),c(!1);return}const t=j*1.1+(k?.fee||0);if(o==="cod"){const a=await g.placeOrder({items:m,total:t,shipping:s,paymentMethod:o});C.current=!0,A(),b("/order-success",{state:{orderId:a.orderId,total:t,paymentMethod:"Cash on Delivery",orderData:a.orderData}})}else if(o==="online"){if(!F){x({title:"Payment Gateway Not Configured",description:"Razorpay is not configured. Please contact administrator.",variant:"destructive"}),c(!1);return}if(!W){x({title:"Payment Gateway Disabled",description:"Razorpay payment gateway is currently disabled. Please use Cash on Delivery.",variant:"destructive"}),c(!1);return}const a=await g.createRazorpayOrder(t);if(!a.success)throw new Error(a.message||"Failed to create payment order");const n=a.order,se={key:F,amount:n.amount,currency:n.currency,name:"V-Commerce",description:"Order Payment",order_id:n.id,handler:async function(f){c(!0);try{const u=await g.verifyRazorpayPayment({razorpay_order_id:f.razorpay_order_id,razorpay_payment_id:f.razorpay_payment_id,razorpay_signature:f.razorpay_signature,orderData:{items:m,total:t,shipping:s}});u.success?(C.current=!0,A(),b("/order-success",{state:{orderId:u.orderId,total:t,paymentMethod:"Online (Razorpay)",orderData:u.orderData}})):x({title:"Payment Verification Failed",description:u.message,variant:"destructive"})}catch(u){console.error("Verification failed",u),x({title:"Verification Error",description:u.message,variant:"destructive"})}finally{c(!1)}},prefill:{name:s.fullName,email:JSON.parse(localStorage.getItem("user"))?.email||"",contact:s.phoneNumber},theme:{color:"#000000"}},M=new window.Razorpay(se);M.on("payment.failed",function(f){x({title:"Payment Failed",description:f.error.description,variant:"destructive"})}),M.open(),c(!1)}}catch(s){console.error("Order failed",s),x({title:"Order Failed",description:s.message||"Something went wrong. Please try again.",variant:"destructive"})}finally{o!=="online"&&c(!1)}};return e.jsxs("div",{className:"container py-8 max-w-4xl min-h-screen",children:[e.jsx("div",{className:"mb-12",children:e.jsxs("div",{className:"flex items-center justify-between relative max-w-2xl mx-auto",children:[e.jsx("div",{className:"absolute left-0 top-1/2 w-full h-1 bg-muted -translate-y-1/2 -z-10"}),xe.map(s=>{const t=s.icon,a=s.id===d,n=s.id<d;return e.jsxs("div",{className:"flex flex-col items-center bg-background px-4",children:[e.jsx(h.div,{initial:!1,animate:{backgroundColor:a||n?"hsl(var(--primary))":"hsl(var(--background))",borderColor:a||n?"hsl(var(--primary))":"hsl(var(--muted-foreground))",color:a||n?"hsl(var(--primary-foreground))":"hsl(var(--muted-foreground))",scale:a?1.2:1},className:"flex items-center justify-center w-12 h-12 rounded-full border-2 transition-all duration-500 shadow-lg",children:e.jsx(t,{className:"h-6 w-6"})}),e.jsx("span",{className:`mt-3 text-xs md:text-sm font-bold uppercase tracking-widest ${a||n?"text-primary":"text-muted-foreground opacity-50"}`,children:s.name})]},s.id)})]})}),e.jsxs("div",{className:"grid lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(B,{className:"border-none shadow-2xl bg-card rounded-3xl overflow-hidden",children:[e.jsx(K,{className:"bg-primary/5 border-b border-primary/10 py-6",children:e.jsxs(V,{className:"text-2xl font-black text-primary",children:[d===1&&"Shipping Details",d===2&&"Payment Method",d===3&&"Review Order"]})}),e.jsxs(q,{className:"p-6 md:p-8",children:[e.jsxs(T,{mode:"wait",children:[d===1&&e.jsxs(h.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"space-y-8",children:[!v&&l.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.3em] text-muted-foreground",children:"Select Shipping Address"}),e.jsx("div",{className:"grid gap-4",children:l.map(s=>e.jsxs("button",{onClick:()=>D(s._id),className:`flex items-start gap-4 p-5 rounded-3xl border-2 text-left transition-all ${p===s._id?"border-primary bg-primary/5 shadow-inner":"border-border hover:border-primary/20"}`,children:[e.jsx("div",{className:`mt-1 h-5 w-5 rounded-full border-2 flex items-center justify-center ${p===s._id?"border-primary":"border-muted-foreground/30"}`,children:p===s._id&&e.jsx("div",{className:"h-2.5 w-2.5 rounded-full bg-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-black text-sm",children:s.fullName}),e.jsx(le,{variant:"outline",className:"text-[9px] py-0",children:s.addressType})]}),e.jsxs("p",{className:"text-xs text-muted-foreground leading-tight",children:[s.street,", ",s.city,", ",s.state," ",s.zipCode]})]})]},s._id))}),e.jsxs(y,{variant:"outline",className:"w-full rounded-2xl border-dashed h-14 font-bold",onClick:()=>w(!0),children:[e.jsx(me,{className:"h-4 w-4 mr-2"})," Add New Address"]})]}),(v||l.length===0)&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-black uppercase tracking-[0.3em] text-muted-foreground",children:"New Shipping Address"}),l.length>0&&e.jsx(y,{variant:"ghost",size:"sm",className:"text-[10px] font-black uppercase",onClick:()=>w(!1),children:"Use Saved Address"})]}),e.jsx(ce,{formData:i,handleChange:X,showSubmitButton:!1})]})]},"step1"),d===2&&e.jsxs(h.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"space-y-8",children:[e.jsx("div",{className:"flex justify-center py-4",children:[{id:"online",name:"Online Payment",icon:"ðŸ’³",disabled:!1}].map(s=>e.jsxs("button",{type:"button",onClick:()=>!s.disabled&&L(s.id),disabled:s.disabled,className:`w-full max-w-[280px] p-8 rounded-[32px] border-2 flex flex-col items-center gap-4 transition-all relative ${o===s.id?"border-primary bg-primary/5 shadow-[0_0_25px_rgba(var(--primary-rgb),0.1)] scale-105":"border-border hover:border-primary/50"} ${s.disabled?"opacity-50 cursor-not-allowed grayscale":""}`,children:[e.jsx("span",{className:"text-4xl",children:s.icon}),e.jsx("span",{className:"font-black text-xs uppercase tracking-[0.2em]",children:s.name}),o===s.id&&e.jsx(h.div,{layoutId:"active",className:"h-2 w-2 rounded-full bg-primary mt-auto"})]},s.id))}),e.jsx("div",{className:"pt-6 border-t border-dashed",children:e.jsx(T,{mode:"wait",children:o==="online"&&e.jsxs(h.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"p-8 rounded-[40px] bg-primary/5 flex flex-col items-center text-center space-y-4 border border-primary/10",children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-primary/10 flex items-center justify-center text-3xl",children:"ðŸ’³"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-black text-xl",children:"Secure Online Payment"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pay securely using Cards, NetBanking, UPI, or Wallets via Razorpay."})]})]},"online-info")})})]},"step2"),d===3&&e.jsxs(h.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"space-y-6",children:[e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"rounded-2xl border bg-muted/30 p-6 space-y-3",children:[e.jsx("h4",{className:"font-black uppercase text-xs tracking-widest text-primary",children:"Shipping To:"}),e.jsx("p",{className:"text-sm font-medium leading-relaxed",children:v?e.jsxs(e.Fragment,{children:[i.firstName," ",i.lastName,e.jsx("br",{}),i.address,e.jsx("br",{}),i.city,", ",i.zip]}):e.jsxs(e.Fragment,{children:[l.find(s=>s._id===p)?.fullName,e.jsx("br",{}),l.find(s=>s._id===p)?.street,e.jsx("br",{}),l.find(s=>s._id===p)?.city,", ",l.find(s=>s._id===p)?.zipCode]})})]}),e.jsxs("div",{className:"rounded-2xl border bg-muted/30 p-6 space-y-3",children:[e.jsx("h4",{className:"font-black uppercase text-xs tracking-widest text-primary",children:"Payment Via:"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-2xl",children:o==="online"?"ðŸ’³":"ðŸ’µ"}),e.jsx("p",{className:"text-sm font-black uppercase tracking-widest",children:o==="online"?"Online Payment":"Cash on Delivery"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-black uppercase text-xs tracking-widest text-primary",children:"Items in Order:"}),e.jsx("div",{className:"space-y-3",children:m.map((s,t)=>e.jsxs("div",{className:"flex justify-between items-center text-sm p-3 bg-muted/30 rounded-xl",children:[e.jsxs("span",{className:"font-medium",children:[e.jsxs("span",{className:"text-primary font-black mr-2",children:[s.quantity,"x"]})," ",s.name]}),e.jsxs("span",{className:"font-black",children:["â‚¹",e.jsx(S,{value:(s.discountPrice||s.price)*s.quantity,decimals:2})]})]},s.pid||s.id||t))})]})]},"step3")]}),e.jsxs("div",{className:"flex justify-between pt-10 border-t mt-10",children:[d>1?e.jsx(y,{variant:"ghost",onClick:Z,className:"rounded-full px-8 hover:bg-muted font-bold uppercase tracking-widest text-xs",children:"Back"}):e.jsx("div",{}),d<3?e.jsx(y,{onClick:Y,className:"rounded-full px-12 font-bold uppercase tracking-widest text-xs shadow-lg hover:shadow-primary/20 scale-105 transition-all",children:"Next Step"}):e.jsx(y,{onClick:ee,disabled:R,className:"rounded-full px-12 font-bold uppercase tracking-widest text-xs shadow-lg hover:shadow-primary/20 scale-105 transition-all",children:R?"Processing...":"Place Order"})]})]})]})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(B,{className:"sticky top-24 border-none shadow-xl bg-card rounded-3xl overflow-hidden",children:[e.jsx(K,{className:"bg-primary py-6",children:e.jsx(V,{className:"text-xl font-black text-primary-foreground uppercase tracking-widest",children:"Summary"})}),e.jsxs(q,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-3 text-sm font-medium",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Subtotal"}),e.jsxs("span",{className:"font-black",children:["â‚¹",e.jsx(S,{value:j,decimals:2})]})]}),e.jsxs("div",{className:"flex justify-between items-center text-primary",children:[e.jsx("span",{className:"text-muted-foreground font-medium",children:"Shipping Fee"}),e.jsx("span",{className:"font-black",children:H?"...":k?`â‚¹${k.fee}`:"Calculated at next step"})]}),I&&e.jsxs("div",{className:"flex justify-between items-center text-green-600 bg-green-50 p-2 rounded-lg border border-green-100 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-3 w-3"}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest",children:"Est. Delivery"})]}),e.jsxs("span",{className:"text-[10px] font-black",children:[I," Days"]})]}),e.jsxs("div",{className:"flex justify-between items-center border-t pt-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Tax (10%)"}),e.jsxs("span",{className:"font-black",children:["â‚¹",e.jsx(S,{value:j*.1,decimals:2})]})]})]}),e.jsx(oe,{className:"opacity-50"}),e.jsx("div",{className:"flex justify-between items-end",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground mb-1",children:"Total Amount"}),e.jsxs("span",{className:"text-3xl font-black text-primary leading-none",children:["â‚¹",e.jsx(S,{value:j*1.1+(k?.fee||0),decimals:2})]})]})})]})]})})]})]})};export{Pe as default};

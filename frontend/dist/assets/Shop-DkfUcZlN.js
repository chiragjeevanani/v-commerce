import{u as ee,b as te,r as n,R as se,j as e,S as re,c as oe,B as z,d as ae,e as ne,f as ce,g as ie,m as J,A as le}from"./index-BpRMWdVM.js";import{p as U}from"./products.service-CJOEitO_.js";import{P as de}from"./ProductCard-B-Z6UzWT.js";import{S as ue}from"./slider-BS68g0dW.js";import{C as he}from"./checkbox-D_9u4xlA.js";import{S as ge,a as me,b as pe,c as fe,d as E}from"./select-C9VlvrKJ.js";import{S as xe}from"./SkeletonCard-CdR-J2Np.js";import{F as Se}from"./funnel-CpbcXKkx.js";import{L as je}from"./loader-circle-BIr11ka_.js";import"./card-CyVSnPS_.js";import"./eye-D0NRzLWa.js";import"./index-BdQq_4o_.js";import"./index-D0VtG131.js";const ke=()=>{const[S,I]=ee(),{toast:W}=te(),[L,N]=n.useState([]),[_,G]=n.useState([]),[u,T]=n.useState(!0),[h,k]=n.useState(!1),[H,q]=n.useState(1),[l,m]=n.useState(!0),[p,A]=n.useState([0,1e3]),[B,R]=n.useState([]),[j,K]=n.useState("featured"),[Pe,ve]=n.useState(20),D=n.useRef(null),d=n.useRef(!1),P=n.useRef(0),x=1500;n.useEffect(()=>{(async()=>{try{const s=await U.fetchCategories();if(s){const r=[];s.forEach(a=>{r.push({id:a.categoryFirstId,name:a.categoryFirstName,level:1}),a.categoryFirstList?.forEach(c=>{r.push({id:c.categorySecondId,name:c.categorySecondName,level:2}),c.categorySecondList?.forEach(o=>{r.push({id:o.categoryId,name:o.categoryName,level:3})})})}),G(r)}}catch(s){console.error("Error fetching categories",s)}})()},[]);const b=async(t,s=!1)=>{if(s)T(!0),d.current=!0;else{const r=Date.now(),a=r-P.current;if(a<x){const c=x-a;console.log(`[Shop LoadMore] Rate limiting: waiting ${c}ms before next request`),setTimeout(()=>{!d.current&&l&&b(t,s)},c);return}k(!0),d.current=!0,P.current=r}try{const r=S.get("category"),a=S.get("search"),c={page:t,size:20,categoryId:r||void 0,keyWord:a||void 0,skipCache:!s};console.log(`[Shop] Fetching page ${t}...`);const o=await U.getSupplierProducts(c);if(o&&o.products)if(t===1){N(o.products);const i=o.totalPages,f=i?t<i:o.products.length>=20;m(f),console.log(`[Shop InitialLoad] Loaded ${o.products.length} products, Page ${t}/${i||"?"}, hasMore: ${f}`)}else{N(w=>{const $=new Set,M=new Set;w.forEach(g=>{g.id&&$.add(String(g.id)),g.pid&&M.add(String(g.pid))});const y=o.products.filter(g=>{const C=g.id,F=g.pid,X=C&&$.has(String(C)),Z=F&&M.has(String(F));return X||Z?!1:(C&&$.add(String(C)),F&&M.add(String(F)),!0)});if(y.length===0&&o.products.length>0&&(console.warn(`[Shop LoadMore] ⚠️ All ${o.products.length} products from page ${t} are duplicates!`),t>2))return console.warn(`[Shop LoadMore] ⛔ Stopping infinite scroll - CJ API returning duplicates (page ${t})`),m(!1),w;const Y=[...w,...y];return console.log(`[Shop LoadMore] ✅ Added ${y.length} new products (${o.products.length-y.length} duplicates filtered), Total: ${Y.length}`),Y});const i=o.totalPages,f=i?t<i:o.products.length>=20;m(f),console.log(`[Shop LoadMore] Page ${t}/${i||"?"}, Has more products: ${f}`)}else m(!1)}catch(r){console.error("[Shop] Error fetching products",r),W({title:"Error",description:"Failed to load products.",variant:"destructive"}),m(!1)}finally{T(!1),k(!1),d.current=!1}};n.useEffect(()=>{q(1),N([]),m(!0),d.current=!1,b(1,!0)},[S]);const v=n.useCallback(async()=>{if(d.current||u||h||!l)return;const t=H+1;console.log(`[Shop LoadMore] Loading page ${t}...`),await b(t,!1),q(t)},[H,u,h,l]);n.useEffect(()=>{const t=new IntersectionObserver(r=>{if(r[0].isIntersecting&&!d.current&&!u&&!h&&l){const o=Date.now()-P.current;if(o>=x)console.log("[Shop IntersectionObserver] ✅ Triggering loadMoreProducts"),v();else{const i=x-o;console.log(`[Shop IntersectionObserver] Rate limited: ${i}ms remaining`)}}},{root:null,rootMargin:"300px",threshold:.1}),s=D.current;return s&&t.observe(s),()=>{s&&t.unobserve(s)}},[v,u,h,l]),n.useEffect(()=>{const t=()=>{if(u||h||!l||d.current)return;const a=window.innerHeight,c=window.scrollY,i=document.documentElement.scrollHeight-400;a+c>=i&&Date.now()-P.current>=x&&(console.log("[Shop ScrollHandler] ✅ Triggering loadMoreProducts"),v())};let s=!1;const r=()=>{s||(window.requestAnimationFrame(()=>{t(),s=!1}),s=!0)};return window.addEventListener("scroll",r,{passive:!0}),()=>window.removeEventListener("scroll",r)},[v,u,h,l]);const O=se.useMemo(()=>{let t=[...L];return t=t.filter(s=>{const r=String(s.sellPrice||"0"),a=r.includes("-")?parseFloat(r.split("-")[0]):parseFloat(r);return a>=p[0]&&a<=p[1]}),j==="price-asc"?t.sort((s,r)=>{const a=String(s.sellPrice).includes("-")?parseFloat(s.sellPrice.split("-")[0]):parseFloat(s.sellPrice),c=String(r.sellPrice).includes("-")?parseFloat(r.sellPrice.split("-")[0]):parseFloat(r.sellPrice);return a-c}):j==="price-desc"&&t.sort((s,r)=>{const a=String(s.sellPrice).includes("-")?parseFloat(s.sellPrice.split("-")[0]):parseFloat(s.sellPrice);return(String(r.sellPrice).includes("-")?parseFloat(r.sellPrice.split("-")[0]):parseFloat(r.sellPrice))-a}),t},[L,p,j]),Q=t=>{const s=new URLSearchParams(S);B.includes(t)?(s.delete("category"),R([])):(s.set("category",t),R([t])),I(s)},V=()=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Top Categories"}),e.jsx("div",{className:"space-y-1 max-h-[400px] overflow-y-auto pr-2 scrollbar-thin",children:_.filter(t=>t.level===1).map(t=>e.jsxs("div",{className:"flex items-center space-x-2 py-1",children:[e.jsx(he,{id:`cat-${t.id}`,checked:B.includes(t.id),onCheckedChange:()=>Q(t.id)}),e.jsx("label",{htmlFor:`cat-${t.id}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer",children:t.name})]},t.id))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Price Range"}),e.jsx(ue,{defaultValue:[0,1e3],max:1e3,step:10,value:p,onValueChange:A,className:"mb-4"}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{children:["₹",p[0]]}),e.jsxs("span",{children:["₹",p[1]]})]})]})]});return e.jsx("div",{className:"container py-8",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-8",children:[e.jsx("div",{className:"hidden md:block w-64 flex-shrink-0 space-y-8",children:e.jsx(V,{})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Shop"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(re,{children:[e.jsx(oe,{asChild:!0,children:e.jsxs(z,{variant:"outline",className:"md:hidden",children:[e.jsx(Se,{className:"mr-2 h-4 w-4"})," Filters"]})}),e.jsxs(ae,{side:"left",children:[e.jsxs(ne,{children:[e.jsx(ce,{children:"Filters"}),e.jsx(ie,{className:"sr-only",children:"Filter products by category and price range."})]}),e.jsx("div",{className:"mt-6",children:e.jsx(V,{})})]})]}),e.jsxs(ge,{value:j,onValueChange:K,children:[e.jsx(me,{className:"w-[180px]",children:e.jsx(pe,{placeholder:"Sort by"})}),e.jsxs(fe,{children:[e.jsx(E,{value:"featured",children:"Featured"}),e.jsx(E,{value:"price-asc",children:"Price: Low to High"}),e.jsx(E,{value:"price-desc",children:"Price: High to Low"})]})]})]})]}),u?e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6",children:Array.from({length:20}).map((t,s)=>e.jsx(xe,{},s))}):O.length>0?e.jsxs(e.Fragment,{children:[e.jsx(J.div,{layout:!0,className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6",children:e.jsx(le,{mode:"popLayout",children:O.map((t,s)=>e.jsx(J.div,{layout:!0,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{duration:.3,delay:s%20*.05},children:e.jsx(de,{product:t})},t.id||s))})}),e.jsx("div",{ref:D,className:"h-20 flex items-center justify-center mt-8 mb-20",children:h?e.jsxs(e.Fragment,{children:[e.jsx(je,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:"Loading more products..."})]}):l?e.jsx("span",{className:"text-sm text-muted-foreground",children:"Scroll for more products..."}):L.length>0?e.jsx("span",{className:"text-sm text-muted-foreground",children:"You've reached the end of our collection"}):null})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-xl text-muted-foreground",children:"No products found."}),e.jsx(z,{variant:"link",onClick:()=>{R([]),A([0,1e3]),I({})},children:"Clear all filters"})]})]})]})})};export{ke as default};
